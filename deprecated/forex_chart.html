<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPtrader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e1e1e1;
            overflow: hidden;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #00b07c;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        select {
            padding: 8px 12px;
            border: 1px solid #333;
            background: #1a1a1a;
            color: #e1e1e1;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }
        
        select:hover {
            border-color: #444;
        }
        
        .status {
            font-size: 14px;
            color: #666;
        }
        
        .status.connected {
            color: #00b07c;
        }
        
        .status.error {
            color: #ef5350;
        }
        
        #chart {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
        }
        
        .price-info {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            min-width: 200px;
            z-index: 50;
            backdrop-filter: blur(10px);
        }
        
        .price-info .current {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .price-info .change {
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .price-info .change.positive {
            color: #00b07c;
        }
        
        .price-info .change.negative {
            color: #ef5350;
        }
        
        .price-info .stats {
            display: grid;
            gap: 8px;
            font-size: 13px;
            color: #888;
        }
        
        .price-info .stats span {
            color: #e1e1e1;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">SPtrader</div>
        <div class="controls">
            <select id="symbolSelect">
                <option value="EURUSD">EUR/USD</option>
                <option value="GBPUSD" selected>GBP/USD</option>
                <option value="USDJPY">USD/JPY</option>
                <option value="USDCHF">USD/CHF</option>
                <option value="AUDUSD">AUD/USD</option>
            </select>
            <select id="timeframeSelect">
                <option value="1m">1m</option>
                <option value="5m" selected>5m</option>
                <option value="15m">15m</option>
                <option value="1h">1h</option>
            </select>
            <div id="status" class="status">Loading...</div>
        </div>
    </div>
    
    <div class="price-info" id="priceInfo" style="display: none;">
        <div class="current" id="currentPrice">-</div>
        <div class="change" id="priceChange">-</div>
        <div class="stats">
            <div>High: <span id="highPrice">-</span></div>
            <div>Low: <span id="lowPrice">-</span></div>
            <div>Updated: <span id="lastUpdate">-</span></div>
        </div>
    </div>
    
    <div id="chart"></div>

    <script>
        let chart;
        let updateTimer;
        let currentData = [];
        
        // Initialize chart with optimized settings
        function initChart() {
            const chartDom = document.getElementById('chart');
            chart = echarts.init(chartDom, null, {
                renderer: 'canvas',
                useDirtyRect: true
            });
            
            const option = {
                animation: false,
                grid: {
                    top: 20,
                    right: 80,
                    bottom: 80,
                    left: 80
                },
                xAxis: {
                    type: 'category',
                    data: [],
                    scale: true,
                    boundaryGap: true,
                    axisLine: { lineStyle: { color: '#333' } },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#666',
                        fontSize: 11,
                        formatter: function(value, index) {
                            // Show every Nth label based on zoom level
                            const totalLabels = chart.getOption().xAxis[0].data.length;
                            const zoom = chart.getOption().dataZoom[0];
                            const visibleRange = zoom.end - zoom.start;
                            const visibleCount = Math.floor(totalLabels * visibleRange / 100);
                            
                            // Calculate label frequency
                            let showEvery = 1;
                            if (visibleCount > 200) showEvery = 20;
                            else if (visibleCount > 100) showEvery = 10;
                            else if (visibleCount > 50) showEvery = 5;
                            else if (visibleCount > 25) showEvery = 2;
                            
                            if (index % showEvery !== 0) return '';
                            
                            const date = new Date(value);
                            const hours = date.getHours();
                            const minutes = date.getMinutes();
                            
                            // Show date at day boundaries
                            if (hours === 0 && minutes === 0) {
                                return date.toLocaleDateString([], { 
                                    month: 'short', 
                                    day: 'numeric' 
                                });
                            }
                            
                            // Show time
                            return date.toLocaleTimeString([], { 
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                        }
                    },
                    splitLine: { show: false }
                },
                yAxis: {
                    scale: true,
                    position: 'right',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#666',
                        fontSize: 11,
                        formatter: (value) => value.toFixed(5)
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#1a1a1a'
                        }
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0],
                        start: 70,
                        end: 100,
                        minSpan: 5,      // Minimum 5% of data visible
                        maxSpan: 100,    // Maximum 100% visible
                        zoomOnMouseWheel: true,
                        moveOnMouseMove: true,
                        moveOnMouseWheel: false,
                        preventDefaultMouseMove: true,
                        zoomLock: false,
                        throttle: 100
                    },
                    {
                        type: 'slider',
                        xAxisIndex: [0],
                        start: 70,
                        end: 100,
                        height: 30,
                        bottom: 10,
                        borderColor: 'transparent',
                        backgroundColor: 'rgba(26, 26, 26, 0.5)',
                        fillerColor: 'rgba(0, 176, 124, 0.1)',
                        handleStyle: {
                            borderColor: '#00b07c',
                            color: '#00b07c'
                        },
                        textStyle: {
                            color: '#666',
                            fontSize: 11
                        },
                        brushSelect: false,
                        realtime: true,
                        showDetail: false
                    }
                ],
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        lineStyle: {
                            color: '#666',
                            width: 0.5
                        }
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    borderColor: '#333',
                    textStyle: { color: '#e1e1e1' },
                    position: function (pos, params, el, elRect, size) {
                        const obj = { top: 80 };
                        obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 30;
                        return obj;
                    },
                    formatter: function(params) {
                        if (!params[0]) return '';
                        const data = params[0].data;
                        const date = new Date(params[0].axisValue);
                        return `
                            ${date.toLocaleString()}<br/>
                            O: ${data[1].toFixed(5)}<br/>
                            H: ${data[4].toFixed(5)}<br/>
                            L: ${data[3].toFixed(5)}<br/>
                            C: ${data[2].toFixed(5)}
                        `;
                    }
                },
                series: [{
                    type: 'candlestick',
                    data: [],
                    itemStyle: {
                        color: '#00b07c',
                        color0: '#ef5350',
                        borderColor: '#00b07c',
                        borderColor0: '#ef5350',
                        borderWidth: 1
                    },
                    barMaxWidth: 10,
                    barMinWidth: 1,
                    barCategoryGap: '20%'
                }]
            };
            
            chart.setOption(option);
            
            // Handle resize
            window.addEventListener('resize', () => {
                chart.resize();
            });
        }
        
        // Fetch and update data
        async function fetchData() {
            const symbol = document.getElementById('symbolSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            
            try {
                updateStatus('Loading...', false);
                
                // Query gets more data but properly excludes weekends
                const query = `
                    SELECT 
                        timestamp,
                        open,
                        high,
                        low,
                        close
                    FROM ohlc_${timeframe}
                    WHERE symbol = '${symbol}'
                    AND timestamp > dateadd('d', -7, now())
                    AND NOT (
                        (EXTRACT(ISODOW FROM timestamp) = 5 AND EXTRACT(HOUR FROM timestamp) >= 21) OR
                        EXTRACT(ISODOW FROM timestamp) = 6 OR
                        (EXTRACT(ISODOW FROM timestamp) = 7 AND EXTRACT(HOUR FROM timestamp) < 21)
                    )
                    ORDER BY timestamp ASC
                `;
                
                const response = await fetch(
                    'http://localhost:8081/exec?' + 
                    new URLSearchParams({ query: query.trim() })
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data?.dataset?.length) {
                    updateStatus('No data', true);
                    return;
                }
                
                // Transform data
                const timestamps = [];
                const candlesticks = [];
                
                data.dataset.forEach(row => {
                    const [timestamp, open, high, low, close] = row;
                    timestamps.push(timestamp);
                    candlesticks.push([open, close, low, high]);
                });
                
                currentData = candlesticks;
                
                // Calculate optimal zoom based on data length
                let startPercent = 70;
                let endPercent = 100;
                
                // For different timeframes, show different amounts of data
                if (timeframe === '1m') {
                    // Show last 100 candles for 1m
                    const visibleCandles = 100;
                    if (candlesticks.length > visibleCandles) {
                        startPercent = Math.max(0, 100 - (visibleCandles / candlesticks.length * 100));
                    }
                } else if (timeframe === '5m') {
                    // Show last 150 candles for 5m
                    const visibleCandles = 150;
                    if (candlesticks.length > visibleCandles) {
                        startPercent = Math.max(0, 100 - (visibleCandles / candlesticks.length * 100));
                    }
                } else if (timeframe === '15m') {
                    // Show last 100 candles for 15m
                    const visibleCandles = 100;
                    if (candlesticks.length > visibleCandles) {
                        startPercent = Math.max(0, 100 - (visibleCandles / candlesticks.length * 100));
                    }
                } else {
                    // Show last 80 candles for 1h
                    const visibleCandles = 80;
                    if (candlesticks.length > visibleCandles) {
                        startPercent = Math.max(0, 100 - (visibleCandles / candlesticks.length * 100));
                    }
                }
                
                // Update chart
                chart.setOption({
                    xAxis: {
                        data: timestamps
                    },
                    dataZoom: [
                        {
                            start: startPercent,
                            end: endPercent
                        },
                        {
                            start: startPercent,
                            end: endPercent
                        }
                    ],
                    series: [{
                        data: candlesticks,
                        barWidth: null,  // Let ECharts calculate
                        barMaxWidth: timeframe === '1m' ? 3 : timeframe === '5m' ? 5 : 8,
                        barMinWidth: 1,
                        barCategoryGap: '20%'
                    }]
                });
                
                updateStatus(`${candlesticks.length} candles`, false);
                updatePriceInfo(candlesticks);
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error loading data', true);
            }
        }
        
        // Update status
        function updateStatus(text, isError) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = isError ? 'status error' : 'status connected';
        }
        
        // Update price info panel
        function updatePriceInfo(data) {
            if (!data.length) return;
            
            const lastCandle = data[data.length - 1];
            const firstCandle = data[0];
            const currentPrice = lastCandle[1]; // close
            const openPrice = firstCandle[0];
            const change = currentPrice - openPrice;
            const changePercent = (change / openPrice * 100);
            
            let high = -Infinity;
            let low = Infinity;
            
            data.forEach(candle => {
                high = Math.max(high, candle[3]);
                low = Math.min(low, candle[2]);
            });
            
            document.getElementById('currentPrice').textContent = currentPrice.toFixed(5);
            
            const changeEl = document.getElementById('priceChange');
            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(5)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
            changeEl.className = `change ${change >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('highPrice').textContent = high.toFixed(5);
            document.getElementById('lowPrice').textContent = low.toFixed(5);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            document.getElementById('priceInfo').style.display = 'block';
        }
        
        // Event listeners
        document.getElementById('symbolSelect').addEventListener('change', fetchData);
        document.getElementById('timeframeSelect').addEventListener('change', fetchData);
        
        // Initialize
        initChart();
        fetchData();
        
        // Auto-refresh every 10 seconds
        updateTimer = setInterval(fetchData, 10000);
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (updateTimer) clearInterval(updateTimer);
        });
    </script>
</body>
</html>
